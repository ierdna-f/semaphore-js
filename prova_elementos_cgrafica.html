<!DOCTYPE html>
 
<html>
 <head>
 <title>JavaScript Sprite Animation Tutorial</title>
 </head>
 <body>


    <div id="alinha" style="width: 100%; height: 90vh; display: flex; justify-content: center; align-items: center; position: relative;">
        <div>    
		<canvas id='canvasBackground'>
		</canvas>
        </div>
        <div style="position: absolute;">
            <canvas id="canvas"  style="border: 1px solid; background-color: transparent;">
            </canvas>
		</div>
		<div style="position: absolute;">
            <canvas id="canvasTrem"  style="background-color: transparent;">
            </canvas>
        </div>
    </div>

	<script >

		var canvasWidth = 1000; 
		var canvasHeight = 1000;	

		var contador = 0;	
		var contSign = 0;
		 
		var width = 100; 
		var height = 80; 
		
		var widthNSX = 50; 
		var heightNSX = 90; 
		 
		var x=0;
		var y=340;
		
		var a=360;
		var b=650;

		var anguloC = 0;
		var anguloD = 0;
		
		var randomico = 0;
		var andandoA = 0;
		var andandoB = 0;
		
		var sinalEsquerda = 0;
		var sinalDireita = 0;
		 
		var speed = 12; 
		 
		var canvas = document.getElementById('canvas');
		var backGround = document.getElementById('canvasBackground');
		var canvasTrem = document.getElementById('canvasTrem');
		canvas.width = canvasWidth;
		canvas.height = canvasHeight; 
		backGround.width = canvas.width;
		backGround.height = canvas.height;
		canvasTrem.width = canvasWidth;
		canvasTrem.height = canvasHeight;
		 
		
		var ctx = canvas.getContext("2d");
		var ctxBackGround = backGround.getContext("2d");
		var ctxTrem = canvas.getContext("2d");
		 
		var fundo = new Image();
		fundo.src = "elements/bg.png";
		var trem = new Image();
		trem.src = "elements/trem.png";
		
		var rSign = new Image(); 
		rSign.src = "signs/redSign.png";
		var gSign = new Image(); 
		gSign.src = "signs/greenSign.png";
		var ySign = new Image(); 
		ySign.src = "signs/yellowSign.png";
		
		var rSignDeitado = new Image(); 
		rSignDeitado.src = "signs/redSign.png";
		var gSignDeitado = new Image(); 
		gSignDeitado.src = "signs/greenSign.png";
		var ySignDeitado = new Image(); 
		ySignDeitado.src = "signs/yellowSign.png";
		
		var car = new Image(); 
		car.src = "elements/carrinho.png";
		var carHorizontal = new Image(); 
		carHorizontal.src = "elements/carrinho2.png";
		now = Date.now();
		contT = 0
		contS = 500
		contY = 1000
		rd = Math.floor(Math.random() * 2);
		begin = false
		setTimeout(() => {
			initMap()
		},50)
		class Veiculo{
			moving;
			velo;
			posX;
			posY;
			sizeX;
			sizeY;
			posXInicial;
			posYInicial;
			constructor(velo,posX, posY, sizeX, sizeY){
				this.moving = false
				this.velo = velo
				this.posX = posX;
				this.posY = posY;
				this.sizeX = sizeX;
				this.sizeY = sizeY;
				this.posXInicial = posX;
				this.posYInicial = posY;
			}
		}
		class Semaforo{
			posX;
			posY;
			sizeX;
			sizeY;
			cor;
			constructor(posX,posY){
				this.cor = 'Red'
				this.sizeX = 104
				this.sizeY = 140
				this.posX = posX
				this.posY = posY;
			}
		}

		// vertical
		semA = new Semaforo(555, 710);
		carro = new Veiculo(8,450, 1000, 150, 300);
		// horizontal
		semB = new Semaforo(335, 435);
		moto = new Veiculo(8,-300, 600, 300, 140);
	
	
		setTimeout(() => {
			setInterval(controlSigns,500)
			setInterval(execute,1)
		},1000)
		
		function execute(){
			moveCars();
			checkResetVehicle();
		}
		function checkResetVehicle(){
			if(moto.posX > canvas.width)
				moto = new Veiculo(8,-300, 600, 300, 140);
			if(carro.posY < 0 - 200 )
				carro = new Veiculo(8,450, 1000, 150, 300);
		}
		/*
		function calcVelo(){
			if(semA.cor == 'Red' && isBehindCar()){
				carro.velo = 5
			}else if(semA.cor == 'Yellow' && isBehindCar())
				carro.velo = 0
			else if(semA.cor == 'Green')
				carro.velo = 0
			if(semB.cor == 'Red' && isBehindMoto()){
				moto.velo = 5
			}else if(semB.cor == 'Yellow' && isBehindMoto()){
				moto.velo = 10
			}
			else if(semB.cor == 'Green')
				moto.velo = 20
		}*/
		function moveCars(){
			clearCtx();
			moveCar();
			moveMoto();
		}

		function moveCar(){
			ctx.drawImage(car, carro.posX, carro.posY, carro.sizeX, carro.sizeY);
			posicaoYCarro = goUp()
			if((isBehindCar() && posicaoYCarro >= semA.posY - 20) || checkSign(semA.cor,'car',posicaoYCarro)){
				carro.posY = posicaoYCarro
				carro.moving = true
			}
			carro.moving = false
		}
		
		function moveMoto(){
			posicaoXMoto = goRight()
			ctx.drawImage(carHorizontal, moto.posX, moto.posY, moto.sizeX, moto.sizeY);
			if((isBehindMoto() && posicaoXMoto <= semB.posX - 170) || checkSign(semB.cor,'moto',posicaoXMoto)){
				moto.posX = posicaoXMoto
				moto.moving = false
			}
				moto.moving = false
		}
		
		function rotateCarro(){
			//ctx.save();			
			//ctx.translate(350,350);
		}
			
		//	ctx.rotate((anguloC-=1/4) * Math.PI/4.5);
		//	ctx.translate(-350,-350);
		//	x+=speed;					
	//				} else if (x > 350){
			//ctx.translate(350,350);
			//ctx.rotate(- Math.PI/2);
			//ctx.translate(-350,-350);
		//	x+=speed;
	//				} else
		//	x+=speed;				
		//	ctx.drawImage(carro3,x,y,widthc3,heightc3);
		//	ctx.restore();

		function checkSign(semaforo,c,posFutura){
			if(c == 'car'){
				if(semaforo == 'Green' && isBehindMoto())
					return true
				else if(!isBehindCar())
					return true
				else
					false
			}else
				if(semaforo == 'Green' && isBehindCar())
					return true
				else if(isBehindMoto() && posFutura <= semB.posX - 170){
					return true
				}
				else if(!isBehindMoto())
					return true
				else
					return false
		}

		function goUp(){
			return carro.posY - 0.1*carro.velo
		}
		function goRight(){
			return moto.posX + 0.1*moto.velo
		}
		function isBehindCar(){
			return carro.posY >= semA.posY - 20
		}
		
		function isBehindMoto(){	
			return moto.posX <= semB.posX - 170
		}

		function controlSigns(){
			contSign++;
			if(compareDate(1,5.5)){
				setSign('Green','vert')
				semA.cor = 'Green'
				setSign('Red','hori')
				semB.cor = 'Red'
			}
			else if(compareDate(5.5,7)&& semB.cor == 'Red'){
				setSign('Yellow','vert')
				semA.cor = 'Yellow'
			}
			else if(compareDate(7,11.5) && semB.cor == 'Red'){
				setSign('Red','vert')
				semA.cor = 'Red'
				setSign('Green','hori')
				semB.cor = 'Green'
			}
			else if(compareDate(11.5,13) && semA.cor === 'Red'){
				setSign('Yellow','hori')
				semB.cor = 'Yellow'
				now = Date.now()
			}
		}

		function compareDate(inicio, fim){
			return  Date.now() - now >= inicio*1000 && Date.now() - now <= fim*1000
		}
		
		function setSign(cor,way){
			if(way == 'vert'){
				if(cor === 'Yellow')
					ctxBackGround.drawImage(ySign, semA.posX, semA.posY, semA.sizeX, semA.sizeY);
				else if(cor === 'Red')
					ctxBackGround.drawImage(rSign, semA.posX, semA.posY, semA.sizeX, semA.sizeY);
				else if(cor === 'Green')
					ctxBackGround.drawImage(gSign, semA.posX, semA.posY, semA.sizeX, semA.sizeY);
			}else
				if(cor === 'Yellow')
					ctxBackGround.drawImage(ySignDeitado, semB.posX, semB.posY, semB.sizeX, semB.sizeY);
				else if(cor === 'Red')
					ctxBackGround.drawImage(rSignDeitado, semB.posX, semB.posY, semB.sizeX, semB.sizeY);
				else if(cor === 'Green')
					ctxBackGround.drawImage(gSignDeitado, semB.posX, semB.posY, semB.sizeX, semB.sizeY);
		}
	
		function initMap(){
			ctxBackGround.drawImage(fundo, 0, 0, 1000, 1000);
			//ctxTrem.drawImage(trem, 0, 0, 269, 1000);
			ctx.drawImage(car, carro.posX, carro.posY, carro.sizeX, carro.sizeY);
			ctx.drawImage(carHorizontal, moto.posX, moto.posY, moto.sizeX, moto.sizeY);
			ctxBackGround.drawImage(rSign, semA.posX, semA.posY, semA.sizeX, semA.sizeY);
			ctxBackGround.drawImage(rSignDeitado, semB.posX, semB.posY, semB.sizeX, semB.sizeY);
		}
		
		function clearCtx(){
			ctx.clearRect(0, 0, canvas.width, canvas.height);
		}

	</script>
 </body>
</html>